<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astrology Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px;
        }
        .form-control {
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .btn-outline-secondary {
            border-radius: 5px;
            padding: 10px 20px;
        }
        .tab-content {
            padding: 20px;
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            font-weight: 600;
        }
        .planet-table {
            width: 100%;
            border-collapse: collapse;
        }
        .planet-table th, .planet-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .planet-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .planet-table tr:hover {
            background-color: #f1f3f5;
        }
        .zodiac-symbol {
            font-size: 1.2em;
            margin-right: 5px;
        }
        .exalted { color: #1a9850; }
        .own { color: #66bd63; }
        .friend { color: #a6d96a; }
        .neutral { color: #ffffbf; }
        .enemy { color: #fdae61; }
        .debilitated { color: #d73027; }
        .retrograde { font-style: italic; }
        #chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .test-profile-dropdown {
            margin-bottom: 15px;
        }
        
        /* Divisional Charts Styling */
        .divisional-tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 15px;
        }
        
        .divisional-tab {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            font-size: 14px;
        }
        
        .divisional-tab:hover {
            background-color: #ddd;
        }
        
        .divisional-tab.active {
            background-color: #6c5ce7;
            color: white;
        }
        
        .divisional-content {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
        }
        
        .divisional-content.active {
            display: block;
        }
        
        /* Yogas Styling */
        .yoga-category {
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .yoga-category-header {
            background-color: #6c5ce7;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }
        
        .yoga-item {
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .yoga-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .yoga-name {
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 5px;
        }
        
        .yoga-description {
            color: #636e72;
            margin-bottom: 10px;
        }
        
        .yoga-strength {
            font-style: italic;
        }
        
        .yoga-strength.strong {
            color: #00b894;
        }
        
        .yoga-strength.moderate {
            color: #fdcb6e;
        }
        
        .yoga-strength.weak {
            color: #d63031;
        }
        
        /* Chart tooltip and details panel styles */
        .chart-tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            font-size: 0.9rem;
        }
        
        .chart-tooltip h5 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .chart-tooltip p {
            margin-bottom: 5px;
        }
        
        .chart-details-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            display: none;
            z-index: 100;
        }
        
        .details-content {
            padding-right: 20px;
        }
        
        .details-content h4 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .planet {
            transition: all 0.2s ease-in-out;
        }
        
        .house-area:hover {
            fill: rgba(200, 200, 200, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">Vedic Astrology Calculator</h1>
        
        <!-- Test Profile Selection Row -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <select id="test-profiles" class="form-select">
                        <option value="">-- Select Test Profile --</option>
                    </select>
                    <button id="load-profile-btn" class="btn btn-primary">Load</button>
                    <button id="edit-profile-btn" class="btn btn-secondary">Edit</button>
                    <button id="delete-profile-btn" class="btn btn-danger">Delete</button>
                    <button id="add-profile-btn" class="btn btn-success">Add New</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Birth Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="kundli-form">
                            <div class="mb-3">
                                <label for="date" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="time" class="form-label">Time of Birth</label>
                                <input type="time" class="form-control" id="time" required>
                            </div>
                            <div class="mb-3">
                                <label for="place" class="form-label">Place of Birth</label>
                                <input type="text" class="form-control" id="place" placeholder="Search for a city..." autocomplete="off">
                            </div>
                            <div class="row mb-3" id="coordinates" style="display: none;">
                                <div class="col-md-6">
                                    <label for="latitude" class="form-label">Latitude</label>
                                    <input type="number" class="form-control" id="latitude" step="0.000001">
                                </div>
                                <div class="col-md-6">
                                    <label for="longitude" class="form-label">Longitude</label>
                                    <input type="number" class="form-control" id="longitude" step="0.000001">
                                </div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="manual-coordinates">
                                <label class="form-check-label" for="manual-coordinates">Enter coordinates manually</label>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Calculate</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" style="display: none;">
                            <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab" aria-controls="chart" aria-selected="true">Chart</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="planets-tab" data-bs-toggle="tab" data-bs-target="#planets" type="button" role="tab" aria-controls="planets" aria-selected="false">Planets</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dasha-tab" data-bs-toggle="tab" data-bs-target="#dasha" type="button" role="tab" aria-controls="dasha" aria-selected="false">Dasha</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="vimshottari-tab" data-bs-toggle="tab" data-bs-target="#vimshottari" type="button" role="tab" aria-controls="vimshottari" aria-selected="false">Vimshottari</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="panchang-tab" data-bs-toggle="tab" data-bs-target="#panchang" type="button" role="tab" aria-controls="panchang" aria-selected="false">Panchang</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="divisional-tab" data-bs-toggle="tab" data-bs-target="#divisional" type="button" role="tab" aria-controls="divisional" aria-selected="false">Divisional Charts</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="yogas-tab" data-bs-toggle="tab" data-bs-target="#yogas" type="button" role="tab" aria-controls="yogas" aria-selected="false">Yogas</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="shadbala-tab" data-bs-toggle="tab" data-bs-target="#shadbala" type="button" role="tab" aria-controls="shadbala" aria-selected="false">Shadbala</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ishta-kashta-tab" data-bs-toggle="tab" data-bs-target="#ishta-kashta" type="button" role="tab" aria-controls="ishta-kashta" aria-selected="false">Ishta-Kashta</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ashtakavarga-tab" data-bs-toggle="tab" data-bs-target="#ashtakavarga" type="button" role="tab" aria-controls="ashtakavarga" aria-selected="false">Ashtakavarga</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="vimsopaka-tab" data-bs-toggle="tab" data-bs-target="#vimsopaka" type="button" role="tab" aria-controls="vimsopaka" aria-selected="false">Vimsopaka Bala</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="resultTabsContent">
                                <div class="tab-pane fade show active" id="chart" role="tabpanel" aria-labelledby="chart-tab">
                                    <div class="row">
                                        <div class="col-12 text-end mb-2">
                                            <div class="form-check form-switch d-inline-block me-2">
                                                <input class="form-check-input" type="checkbox" id="transitToggle">
                                                <label class="form-check-label" for="transitToggle">Show Transit Overlay</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div id="chart-container">
                                                <div id="chart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="planets" role="tabpanel" aria-labelledby="planets-tab">
                                    <h5 class="mb-3">Planetary Positions</h5>
                                    <div class="mb-3">
                                        <h6>Ascendant (Lagna)</h6>
                                        <table class="planet-table">
                                            <thead>
                                                <tr>
                                                    <th>Sign</th>
                                                    <th>Degrees</th>
                                                    <th>House</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ascendant-table-body">
                                                <!-- Ascendant data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <h6 class="mb-3">Planets</h6>
                                    <table class="planet-table">
                                        <thead>
                                            <tr>
                                                <th>Planet</th>
                                                <th>Sign</th>
                                                <th>Degrees</th>
                                                <th>House</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="planets-table-body">
                                            <!-- Planets data will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane fade" id="dasha" role="tabpanel" aria-labelledby="dasha-tab">
                                    <h5 class="mb-3">Vimshottari Dasha</h5>
                                    <table class="planet-table">
                                        <thead>
                                            <tr>
                                                <th>Planet</th>
                                                <th>Start Date</th>
                                                <th>End Date</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dasha-table-body">
                                            <!-- Dasha data will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane fade" id="vimshottari" role="tabpanel" aria-labelledby="vimshottari-tab">
                                    <h5 class="mb-3">Vimshottari Dasha</h5>
                                    <div class="mb-3">
                                        <p><strong>Birth Date:</strong> <span id="vimshottari-birth-date"></span></p>
                                        <p><strong>Moon Nakshatra:</strong> <span id="vimshottari-moon-nakshatra"></span></p>
                                        <p><strong>Nakshatra Lord:</strong> <span id="vimshottari-nakshatra-lord"></span></p>
                                    </div>
                                    <h6 class="mb-2">Mahadashas (Major Periods)</h6>
                                    <table class="planet-table mb-4">
                                        <thead>
                                            <tr>
                                                <th>Planet</th>
                                                <th>Start Date</th>
                                                <th>End Date</th>
                                                <th>Duration</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vimshottari-table-body">
                                            <!-- Vimshottari data will be inserted here -->
                                        </tbody>
                                    </table>
                                    
                                    <div id="antardasha-container" style="display: none;">
                                        <h6 class="mb-2">Antardashas (Sub-Periods)</h6>
                                        <h6 id="antardasha-title" class="text-muted mb-2"></h6>
                                        <table class="planet-table">
                                            <thead>
                                                <tr>
                                                    <th>Planet</th>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Duration</th>
                                                </tr>
                                            </thead>
                                            <tbody id="antardasha-table-body">
                                                <!-- Antardasha data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="panchang" role="tabpanel" aria-labelledby="panchang-tab">
                                    <h5 class="mb-3">Panchang Details</h5>
                                    <table class="planet-table">
                                        <thead>
                                            <tr>
                                                <th>Element</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="panchang-table-body">
                                            <!-- Panchang data will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane fade" id="divisional" role="tabpanel" aria-labelledby="divisional-tab">
                                    <h5 class="mb-3">Divisional Charts (Varga)</h5>
                                    <div class="divisional-tabs">
                                        <button class="divisional-tab active" onclick="openDivisionalTab(event, 'D9')">Navamsa (D9)</button>
                                        <button class="divisional-tab" onclick="openDivisionalTab(event, 'D12')">Dwadasamsa (D12)</button>
                                    </div>
                                    
                                    <!-- D9 Chart -->
                                    <div id="D9" class="divisional-content active">
                                        <h4>Navamsa Chart (D9)</h4>
                                        <p>The Navamsa chart is the 9th divisional chart and is considered one of the most important divisional charts in Vedic astrology. It provides insights into marriage, partnerships, and deeper spiritual aspects of life.</p>
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Planet</th>
                                                        <th>Sign</th>
                                                        <th>Degree</th>
                                                        <th>House</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="navamsa-table">
                                                    <!-- Navamsa data will be displayed here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- D12 Chart -->
                                    <div id="D12" class="divisional-content">
                                        <h4>Dwadasamsa Chart (D12)</h4>
                                        <p>The Dwadasamsa chart is the 12th divisional chart and provides insights into the parents, ancestors, and past life influences. It's useful for understanding karmic patterns and family dynamics.</p>
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Planet</th>
                                                        <th>Sign</th>
                                                        <th>Degree</th>
                                                        <th>House</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dwadasamsa-table">
                                                    <!-- Dwadasamsa data will be displayed here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="yogas" role="tabpanel" aria-labelledby="yogas-tab">
                                    <h5 class="mb-3">Yogas (Astrological Combinations)</h5>
                                    <p>Yogas are specific planetary combinations that produce particular effects in a birth chart. Below are the yogas present in this chart:</p>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Yogas indicate specific planetary combinations in your birth chart that influence various aspects of life including wealth, power, spirituality, and challenges.
                                    </div>
                                    
                                    <div id="yogas-container" class="mt-4">
                                        <!-- Yogas will be displayed here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="shadbala" role="tabpanel" aria-labelledby="shadbala-tab">
                                    <h5 class="mb-3">Shadbala Calculations</h5>
                                    <p>Shadbala is a system used to calculate the strength of planets in a birth chart.</p>
                                    <div id="shadbala-content" class="mt-4">
                                        <!-- Shadbala content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="ishta-kashta" role="tabpanel" aria-labelledby="ishta-kashta-tab">
                                    <h5 class="mb-3">Ishta-Kashta Phala</h5>
                                    <p>Ishta-Kashta Phala is a system used to calculate the strength of planets in a birth chart.</p>
                                    <div id="ishta-kashta-content" class="mt-4">
                                        <!-- Ishta-Kashta Phala content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="ashtakavarga" role="tabpanel" aria-labelledby="ashtakavarga-tab">
                                    <h5 class="mb-3">Ashtakavarga System</h5>
                                    <p>The Ashtakavarga system is a key Vedic astrology technique for evaluating planetary and house strengths.</p>
                                    
                                    <h6>Sarvashtakavarga (Combined)</h6>
                                    <div id="sarvashtakavarga-container" class="mb-4">
                                        <!-- Sarvashtakavarga data will be displayed here -->
                                    </div>
                                    
                                    <h6>Prastarashtakavarga (Individual Planet)</h6>
                                    <div id="prastarashtakavarga-container" class="mb-4">
                                        <!-- Prastarashtakavarga data will be displayed here -->
                                    </div>
                                    
                                    <h6>Planet Strengths</h6>
                                    <div id="planet-strength-container" class="mb-4">
                                        <!-- Planet strength data will be displayed here -->
                                    </div>
                                    
                                    <h6>House Strengths</h6>
                                    <div id="house-strength-container" class="mb-4">
                                        <!-- House strength data will be displayed here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="vimsopaka" role="tabpanel" aria-labelledby="vimsopaka-tab">
                                    <h5 class="mb-3">Vimsopaka Bala</h5>
                                    <p>Vimsopaka Bala is a system used to calculate the strength of planets in a birth chart.</p>
                                    <div id="vimsopaka-content" class="mt-4">
                                        <!-- Vimsopaka Bala content will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="loading" style="display: none;">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Test Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="profileName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="profileName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="profileDay" class="form-label">Day</label>
                                <input type="number" class="form-control" id="profileDay" min="1" max="31" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="profileMonth" class="form-label">Month</label>
                                <input type="number" class="form-control" id="profileMonth" min="1" max="12" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="profileYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="profileYear" min="1" max="2100" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="profileHour" class="form-label">Hour</label>
                                <input type="number" class="form-control" id="profileHour" min="0" max="23" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="profileMinute" class="form-label">Minute</label>
                                <input type="number" class="form-control" id="profileMinute" min="0" max="59" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="profileSecond" class="form-label">Second</label>
                                <input type="number" class="form-control" id="profileSecond" min="0" max="59" value="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="profileLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="profileLocation" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="profileLatitude" class="form-label">Latitude</label>
                                <input type="number" step="0.000001" class="form-control" id="profileLatitude" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profileLongitude" class="form-label">Longitude</label>
                                <input type="number" step="0.000001" class="form-control" id="profileLongitude" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Profile Modal -->
    <div class="modal fade" id="addProfileModal" tabindex="-1" aria-labelledby="addProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProfileModalLabel">Add New Test Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProfileForm">
                        <div class="mb-3">
                            <label for="newProfileName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="newProfileName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="newProfileDay" class="form-label">Day</label>
                                <input type="number" class="form-control" id="newProfileDay" min="1" max="31" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newProfileMonth" class="form-label">Month</label>
                                <input type="number" class="form-control" id="newProfileMonth" min="1" max="12" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newProfileYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="newProfileYear" min="1" max="2100" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="newProfileHour" class="form-label">Hour</label>
                                <input type="number" class="form-control" id="newProfileHour" min="0" max="23" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newProfileMinute" class="form-label">Minute</label>
                                <input type="number" class="form-control" id="newProfileMinute" min="0" max="59" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newProfileSecond" class="form-label">Second</label>
                                <input type="number" class="form-control" id="newProfileSecond" min="0" max="59" value="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newProfileLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="newProfileLocation" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newProfileLatitude" class="form-label">Latitude</label>
                                <input type="number" step="0.000001" class="form-control" id="newProfileLatitude" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newProfileLongitude" class="form-label">Longitude</label>
                                <input type="number" step="0.000001" class="form-control" id="newProfileLongitude" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createProfileBtn">Create Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this profile? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="{{ url_for('static', filename='js/kundli-chart.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('kundli-form');
            const manualCoordinatesCheckbox = document.getElementById('manual-coordinates');
            const coordinatesDiv = document.getElementById('coordinates');
            const placeInput = document.getElementById('place');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('error-message');
            const testProfilesSelect = document.getElementById('test-profiles');
            const loadProfileBtn = document.getElementById('load-profile-btn');
            
            // Load test profiles
            fetch('/test_profiles')
                .then(response => response.json())
                .then(profiles => {
                    profiles.forEach((profile, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = profile.name;
                        testProfilesSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading test profiles:', error);
                });
            
            // Load profile button click handler
            loadProfileBtn.addEventListener('click', function() {
                const profileId = testProfilesSelect.value;
                if (!profileId) return;
                
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                fetch(`/load_test_profile/${profileId}`)
                    .then(response => response.json())
                    .then(profile => {
                        // Fill form with profile data
                        document.getElementById('date').value = profile.date;
                        document.getElementById('time').value = profile.time.substring(0, 5); // HH:MM format
                        
                        // Enable manual coordinates
                        manualCoordinatesCheckbox.checked = true;
                        coordinatesDiv.style.display = 'flex';
                        placeInput.disabled = true;
                        
                        // Set coordinates
                        latitudeInput.value = profile.latitude;
                        longitudeInput.value = profile.longitude;
                        
                        // Hide loading indicator
                        loadingDiv.style.display = 'none';
                        
                        // Automatically submit the form
                        form.dispatchEvent(new Event('submit'));
                    })
                    .catch(error => {
                        showError('Error loading profile: ' + error.message);
                    });
            });
            
            // Edit profile button click handler
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            let currentProfileId = null;
            
            editProfileBtn.addEventListener('click', function() {
                const profileId = testProfilesSelect.value;
                if (!profileId) {
                    showError('Please select a profile to edit');
                    return;
                }
                
                currentProfileId = profileId;
                
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                fetch(`/load_test_profile/${profileId}`)
                    .then(response => response.json())
                    .then(profile => {
                        // Fill form with profile data
                        document.getElementById('profileName').value = profile.name;
                        
                        // Parse date
                        const dateParts = profile.date.split('-');
                        document.getElementById('profileYear').value = dateParts[0];
                        document.getElementById('profileMonth').value = dateParts[1];
                        document.getElementById('profileDay').value = dateParts[2];
                        
                        // Parse time
                        const timeParts = profile.time.split(':');
                        document.getElementById('profileHour').value = timeParts[0];
                        document.getElementById('profileMinute').value = timeParts[1];
                        document.getElementById('profileSecond').value = timeParts.length > 2 ? timeParts[2] : '0';
                        
                        // Set location and coordinates
                        document.getElementById('profileLocation').value = profile.location || '';
                        document.getElementById('profileLatitude').value = profile.latitude;
                        document.getElementById('profileLongitude').value = profile.longitude;
                        
                        // Hide loading indicator
                        loadingDiv.style.display = 'none';
                        
                        // Show modal
                        editProfileModal.show();
                    })
                    .catch(error => {
                        loadingDiv.style.display = 'none';
                        showError('Error loading profile: ' + error.message);
                    });
            });
            
            saveProfileBtn.addEventListener('click', function() {
                // Get form data
                const profileData = {
                    name: document.getElementById('profileName').value,
                    date: `${document.getElementById('profileYear').value}-${document.getElementById('profileMonth').value.padStart(2, '0')}-${document.getElementById('profileDay').value.padStart(2, '0')}`,
                    time: `${document.getElementById('profileHour').value.padStart(2, '0')}:${document.getElementById('profileMinute').value.padStart(2, '0')}:${document.getElementById('profileSecond').value.padStart(2, '0')}`,
                    location: document.getElementById('profileLocation').value,
                    latitude: parseFloat(document.getElementById('profileLatitude').value),
                    longitude: parseFloat(document.getElementById('profileLongitude').value)
                };
                
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                // Send data to server
                fetch(`/edit_test_profile/${currentProfileId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to save profile');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide modal
                    editProfileModal.hide();
                    
                    // Reload test profiles
                    reloadTestProfiles();
                    
                    // Hide loading indicator
                    loadingDiv.style.display = 'none';
                    
                    // Show success message
                    showSuccess('Profile updated successfully');
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    showError('Error saving profile: ' + error.message);
                });
            });
            
            // Add new profile button click handler
            const addProfileBtn = document.getElementById('add-profile-btn');
            const addProfileModal = new bootstrap.Modal(document.getElementById('addProfileModal'));
            const createProfileBtn = document.getElementById('createProfileBtn');
            
            addProfileBtn.addEventListener('click', function() {
                // Clear form
                document.getElementById('addProfileForm').reset();
                
                // Set default values
                const now = new Date();
                document.getElementById('newProfileYear').value = now.getFullYear();
                document.getElementById('newProfileMonth').value = now.getMonth() + 1;
                document.getElementById('newProfileDay').value = now.getDate();
                document.getElementById('newProfileHour').value = now.getHours();
                document.getElementById('newProfileMinute').value = now.getMinutes();
                document.getElementById('newProfileSecond').value = '0';
                
                // Show modal
                addProfileModal.show();
            });
            
            createProfileBtn.addEventListener('click', function() {
                // Get form data
                const profileData = {
                    name: document.getElementById('newProfileName').value,
                    date: `${document.getElementById('newProfileYear').value}-${document.getElementById('newProfileMonth').value.padStart(2, '0')}-${document.getElementById('newProfileDay').value.padStart(2, '0')}`,
                    time: `${document.getElementById('newProfileHour').value.padStart(2, '0')}:${document.getElementById('newProfileMinute').value.padStart(2, '0')}:${document.getElementById('newProfileSecond').value.padStart(2, '0')}`,
                    location: document.getElementById('newProfileLocation').value,
                    latitude: parseFloat(document.getElementById('newProfileLatitude').value),
                    longitude: parseFloat(document.getElementById('newProfileLongitude').value)
                };
                
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                // Send data to server
                fetch('/add_test_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add profile');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide modal
                    addProfileModal.hide();
                    
                    // Reload test profiles
                    reloadTestProfiles();
                    
                    // Hide loading indicator
                    loadingDiv.style.display = 'none';
                    
                    // Show success message
                    showSuccess('Profile added successfully');
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    showError('Error adding profile: ' + error.message);
                });
            });
            
            // Delete profile button click handler
            const deleteProfileBtn = document.getElementById('delete-profile-btn');
            const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            deleteProfileBtn.addEventListener('click', function() {
                const profileId = testProfilesSelect.value;
                if (!profileId) {
                    showError('Please select a profile to delete');
                    return;
                }
                
                currentProfileId = profileId;
                
                // Show confirmation modal
                confirmDeleteModal.show();
            });
            
            confirmDeleteBtn.addEventListener('click', function() {
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                // Send delete request
                fetch(`/delete_test_profile/${currentProfileId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete profile');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide modal
                    confirmDeleteModal.hide();
                    
                    // Reload test profiles
                    reloadTestProfiles();
                    
                    // Hide loading indicator
                    loadingDiv.style.display = 'none';
                    
                    // Show success message
                    showSuccess('Profile deleted successfully');
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    showError('Error deleting profile: ' + error.message);
                });
            });
            
            // Function to reload test profiles
            function reloadTestProfiles() {
                // Clear select options
                while (testProfilesSelect.options.length > 1) {
                    testProfilesSelect.remove(1);
                }
                
                // Load test profiles
                fetch('/test_profiles')
                    .then(response => response.json())
                    .then(profiles => {
                        profiles.forEach((profile, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = profile.name;
                            testProfilesSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading test profiles:', error);
                    });
            }
            
            // Function to show success message
            function showSuccess(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.classList.remove('alert-danger');
                errorMessageDiv.classList.add('alert-success');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    errorMessageDiv.style.display = 'none';
                }, 3000);
            }
            
            // Function to show error message
            function showError(message) {
                loadingDiv.style.display = 'none';
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.classList.remove('alert-success');
                errorMessageDiv.classList.add('alert-danger');
            }
            
            // Toggle manual coordinates input
            manualCoordinatesCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    coordinatesDiv.style.display = 'flex';
                    placeInput.disabled = true;
                } else {
                    coordinatesDiv.style.display = 'none';
                    placeInput.disabled = false;
                }
            });
            
            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading indicator
                resultsDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                
                // Get form values
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                let latitude, longitude;
                
                if (manualCoordinatesCheckbox.checked) {
                    latitude = parseFloat(latitudeInput.value);
                    longitude = parseFloat(longitudeInput.value);
                    
                    if (isNaN(latitude) || isNaN(longitude)) {
                        showError('Please enter valid coordinates.');
                        return;
                    }
                } else {
                    // For demo, use default coordinates if place is not implemented
                    // In a real app, you would use a geocoding service here
                    latitude = 28.6139;  // New Delhi
                    longitude = 77.2090;
                }
                
                // Prepare data for API call
                const data = {
                    date: date,
                    time: time + ':00',  // Add seconds
                    latitude: latitude,
                    longitude: longitude,
                    timezone: 'UTC'  // Default timezone, would be determined by location in a real app
                };
                
                console.log('Sending data to server:', data);
                
                // Call the API
                fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response text:', text);
                            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}. Details: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data from server:', data);
                    
                    // Hide loading indicator
                    loadingDiv.style.display = 'none';
                    
                    // Process and display results
                    displayResults(data);
                    
                    // Show results
                    resultsDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    showError('Error calculating chart: ' + error.message);
                });
            });
            
            function displayResults(data) {
                // Hide loading indicator
                loadingDiv.style.display = 'none';
                
                // Show results container
                resultsDiv.style.display = 'block';
                
                // Update chart
                createKundliChart(data, 'chart');
                
                // Set up transit toggle
                const transitToggle = document.getElementById('transitToggle');
                if (transitToggle) {
                    transitToggle.addEventListener('change', function() {
                        if (this.checked) {
                            // Fetch transit data and update chart
                            fetchTransitData(data);
                        } else {
                            // Redraw chart without transits
                            createKundliChart(data, 'chart');
                        }
                    });
                }
                
                // Display planets data
                displayPlanetsData(data.planets);
                
                // Display dasha data
                displayDashaData(data.dasha);
                
                // Display Vimshottari Dasha data
                displayVimshottariDashaData(data.vimshottari_dasha);
                
                // Display panchang data
                displayPanchangData(data.panchang);
                
                // Display divisional charts
                displayDivisionalCharts(data.divisional_charts);
                
                // Display yogas
                displayYogasData(data.yogas);
                
                // Display ascendant data
                displayAscendantData(data.ascendant);
                
                // Display ascendant info
                displayAscendantInfo(data.ascendant);
                
                // Display Ashtakavarga data
                displayAshtakavarga(data.ashtakavarga);
                
                // Display Shadbala data
                displayShadbala(data.shadbala);
                
                // Display Vimsopaka Bala data
                displayVimsopakaBala(data.vimsopaka_bala);
                
                // Display Ishta-Kashta Phala data
                displayIshtaKashtaPhala(data.ishta_kashta_phala);
            }
            
            // Function to fetch transit data and update chart
            function fetchTransitData(birthData) {
                fetch('/get_transits')
                    .then(response => response.json())
                    .then(transitData => {
                        if (transitData.success) {
                            // Redraw chart with transit data
                            createKundliChart(birthData, 'chart', transitData);
                            
                            // Show transit calculation time
                            const chartContainer = document.getElementById('chart-container');
                            let transitTimeDiv = document.getElementById('transit-time');
                            if (!transitTimeDiv) {
                                transitTimeDiv = document.createElement('div');
                                transitTimeDiv.id = 'transit-time';
                                transitTimeDiv.className = 'text-muted small mt-2';
                                chartContainer.appendChild(transitTimeDiv);
                            }
                            transitTimeDiv.textContent = `Transit positions as of: ${transitData.calculation_time}`;
                        } else {
                            console.error('Error fetching transit data:', transitData.error);
                            alert('Failed to load transit data. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching transit data:', error);
                        alert('Failed to load transit data. Please try again.');
                    });
            }
            
            // Function to display Vimshottari Dasha data
            function displayVimshottariDashaData(vimshottariDasha) {
                const vimshottariTableBody = document.getElementById('vimshottari-table-body');
                const birthDateSpan = document.getElementById('vimshottari-birth-date');
                const moonNakshatraSpan = document.getElementById('vimshottari-moon-nakshatra');
                const nakshatraLordSpan = document.getElementById('vimshottari-nakshatra-lord');
                
                vimshottariTableBody.innerHTML = '';
                
                if (vimshottariDasha) {
                    // Display basic information
                    birthDateSpan.textContent = formatDate(vimshottariDasha.birth_date);
                    moonNakshatraSpan.textContent = vimshottariDasha.moon_nakshatra;
                    nakshatraLordSpan.textContent = vimshottariDasha.moon_nakshatra_lord;
                    
                    // Display dasha periods
                    if (vimshottariDasha.dasha_periods && vimshottariDasha.dasha_periods.length > 0) {
                        vimshottariDasha.dasha_periods.forEach((period, index) => {
                            const row = document.createElement('tr');
                            
                            const viewAntardashaBtn = document.createElement('button');
                            viewAntardashaBtn.className = 'btn btn-sm btn-secondary';
                            viewAntardashaBtn.textContent = 'View Antardashas';
                            viewAntardashaBtn.onclick = function() {
                                showAntardashas(period);
                            };
                            
                            row.innerHTML = `
                                <td>${getPlanetSymbol(period.planet)} ${period.planet}</td>
                                <td>${formatDate(period.start_date)}</td>
                                <td>${formatDate(period.end_date)}</td>
                                <td>${period.duration}</td>
                                <td></td>
                            `;
                            
                            row.cells[4].appendChild(viewAntardashaBtn);
                            vimshottariTableBody.appendChild(row);
                        });
                    } else {
                        vimshottariTableBody.innerHTML = '<tr><td colspan="5">No dasha periods available</td></tr>';
                    }
                } else {
                    birthDateSpan.textContent = 'Not available';
                    moonNakshatraSpan.textContent = 'Not available';
                    nakshatraLordSpan.textContent = 'Not available';
                    vimshottariTableBody.innerHTML = '<tr><td colspan="5">Vimshottari Dasha data not available</td></tr>';
                }
            }
            
            // Function to show antardashas
            function showAntardashas(period) {
                const antardashaContainer = document.getElementById('antardasha-container');
                const antardashaTitle = document.getElementById('antardasha-title');
                const antardashaTableBody = document.getElementById('antardasha-table-body');
                
                antardashaContainer.style.display = 'block';
                antardashaTitle.textContent = `Antardashas of ${getPlanetSymbol(period.planet)} ${period.planet} (${formatDate(period.start_date)} - ${formatDate(period.end_date)})`;
                
                antardashaTableBody.innerHTML = '';
                
                if (period.antardashas && period.antardashas.length > 0) {
                    period.antardashas.forEach(antardasha => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${getPlanetSymbol(antardasha.planet)} ${antardasha.planet}</td>
                            <td>${formatDate(antardasha.start_date)}</td>
                            <td>${formatDate(antardasha.end_date)}</td>
                            <td>${antardasha.duration}</td>
                        `;
                        antardashaTableBody.appendChild(row);
                    });
                } else {
                    antardashaTableBody.innerHTML = '<tr><td colspan="4">No antardasha data available</td></tr>';
                }
                
                // Scroll to the antardasha container
                antardashaContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Function to display dasha data
            function displayDashaData(dasha) {
                const dashaTableBody = document.getElementById('dasha-table-body');
                dashaTableBody.innerHTML = '';
                
                if (dasha && dasha.periods && dasha.periods.length > 0) {
                    dasha.periods.forEach(period => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${getPlanetSymbol(period.planet)} ${period.planet}</td>
                            <td>${formatDate(period.start_date)}</td>
                            <td>${formatDate(period.end_date)}</td>
                            <td>${period.duration}</td>
                        `;
                        dashaTableBody.appendChild(row);
                    });
                } else {
                    dashaTableBody.innerHTML = '<tr><td colspan="4">Dasha data not available</td></tr>';
                }
            }
            
            // Function to display planets data
            function displayPlanetsData(planets) {
                const planetsTableBody = document.getElementById('planets-table-body');
                planetsTableBody.innerHTML = '';
                
                if (planets && Array.isArray(planets)) {
                    planets.forEach(planet => {
                        const row = document.createElement('tr');
                        
                        // Get zodiac symbol
                        const zodiacInfo = longitudeToZodiac(planet.longitude);
                        const zodiacSymbol = getZodiacSymbol(zodiacInfo.sign);
                        
                        // Format degrees
                        const formattedDegrees = formatDMS(zodiacInfo.degrees);
                        
                        // Determine dignity class
                        let dignityClass = 'neutral';
                        if (planet.dignity) {
                            dignityClass = planet.dignity.toLowerCase();
                        }
                        
                        // Create cells
                        row.innerHTML = `
                            <td>${getPlanetSymbol(planet.name)} ${planet.name}</td>
                            <td><span class="zodiac-symbol">${zodiacSymbol}</span> ${zodiacInfo.sign}</td>
                            <td>${formattedDegrees}</td>
                            <td>${planet.house || '-'}</td>
                            <td class="${dignityClass}${planet.isRetrograde ? ' retrograde' : ''}">
                                ${planet.dignity || 'Neutral'}${planet.isRetrograde ? ' (R)' : ''}
                            </td>
                        `;
                        
                        planetsTableBody.appendChild(row);
                    });
                } else if (planets && typeof planets === 'object') {
                    // Handle planets as an object
                    Object.entries(planets).forEach(([name, planet]) => {
                        const row = document.createElement('tr');
                        
                        // Planet name with symbol
                        const planetCell = document.createElement('td');
                        planetCell.innerHTML = getPlanetSymbol(name) + ' ' + name;
                        row.appendChild(planetCell);
                        
                        // Sign with symbol
                        const signCell = document.createElement('td');
                        signCell.innerHTML = getZodiacSymbol(planet.sign) + ' ' + planet.sign;
                        row.appendChild(signCell);
                        
                        // Degree
                        const degreeCell = document.createElement('td');
                        degreeCell.textContent = formatDegree(planet.degree);
                        row.appendChild(degreeCell);
                        
                        // House
                        const houseCell = document.createElement('td');
                        houseCell.textContent = planet.house;
                        row.appendChild(houseCell);
                        
                        planetsTableBody.appendChild(row);
                    });
                } else {
                    planetsTableBody.innerHTML = '<tr><td colspan="5">Planet data not available</td></tr>';
                }
            }
            
            // Function to display panchang data
            function displayPanchangData(panchang) {
                const panchangTableBody = document.getElementById('panchang-table-body');
                panchangTableBody.innerHTML = '';
                
                if (panchang) {
                    const panchangItems = [
                        { name: 'Tithi', value: panchang.tithi },
                        { name: 'Nakshatra', value: panchang.nakshatra },
                        { name: 'Yoga', value: panchang.yoga },
                        { name: 'Karana', value: panchang.karana },
                        { name: 'Weekday', value: panchang.weekday }
                    ];
                    
                    panchangItems.forEach(item => {
                        if (item.value) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.name}</td>
                                <td>${item.value}</td>
                            `;
                            panchangTableBody.appendChild(row);
                        }
                    });
                } else {
                    panchangTableBody.innerHTML = '<tr><td colspan="2">Panchang data not available</td></tr>';
                }
            }
            
            // Function to display divisional charts data
            function displayDivisionalCharts(divisionalCharts) {
                if (!divisionalCharts) {
                    return;
                }
                
                // Display Navamsa (D9) data
                const navamsaTable = document.getElementById('navamsa-table');
                navamsaTable.innerHTML = '';
                
                if (divisionalCharts.D9) {
                    Object.entries(divisionalCharts.D9).forEach(([planet, data]) => {
                        const row = document.createElement('tr');
                        
                        // Planet name with symbol
                        const planetCell = document.createElement('td');
                        planetCell.innerHTML = getPlanetSymbol(planet) + ' ' + planet;
                        row.appendChild(planetCell);
                        
                        // Sign with symbol
                        const signCell = document.createElement('td');
                        signCell.innerHTML = getZodiacSymbol(data.sign) + ' ' + data.sign;
                        row.appendChild(signCell);
                        
                        // Degree
                        const degreeCell = document.createElement('td');
                        degreeCell.textContent = formatDegree(data.degree);
                        row.appendChild(degreeCell);
                        
                        // House
                        const houseCell = document.createElement('td');
                        houseCell.textContent = data.house;
                        row.appendChild(houseCell);
                        
                        navamsaTable.appendChild(row);
                    });
                }
                
                // Display Dwadasamsa (D12) data
                const dwadasamsaTable = document.getElementById('dwadasamsa-table');
                dwadasamsaTable.innerHTML = '';
                
                if (divisionalCharts.D12) {
                    Object.entries(divisionalCharts.D12).forEach(([planet, data]) => {
                        const row = document.createElement('tr');
                        
                        // Planet name with symbol
                        const planetCell = document.createElement('td');
                        planetCell.innerHTML = getPlanetSymbol(planet) + ' ' + planet;
                        row.appendChild(planetCell);
                        
                        // Sign with symbol
                        const signCell = document.createElement('td');
                        signCell.innerHTML = getZodiacSymbol(data.sign) + ' ' + data.sign;
                        row.appendChild(signCell);
                        
                        // Degree
                        const degreeCell = document.createElement('td');
                        degreeCell.textContent = formatDegree(data.degree);
                        row.appendChild(degreeCell);
                        
                        // House
                        const houseCell = document.createElement('td');
                        houseCell.textContent = data.house;
                        row.appendChild(houseCell);
                        
                        dwadasamsaTable.appendChild(row);
                    });
                }
            }
            
            // Function to display yogas data
            function displayYogasData(yogas) {
                const yogasContainer = document.getElementById('yogas-container');
                yogasContainer.innerHTML = '';
                
                if (!yogas || Object.keys(yogas).length === 0) {
                    yogasContainer.innerHTML = '<p>No significant yogas detected in this chart.</p>';
                    return;
                }
                
                // Create category headers with proper names
                const categoryNames = {
                    'raja_yogas': 'Raja Yogas (Power & Authority)',
                    'dhana_yogas': 'Dhana Yogas (Wealth & Prosperity)',
                    'pancha_mahapurusha_yogas': 'Pancha Mahapurusha Yogas (Five Great Person Yogas)',
                    'nabhasa_yogas': 'Nabhasa Yogas (Special Planetary Formations)',
                    'other_yogas': 'Other Significant Yogas'
                };
                
                // Loop through each yoga category
                for (const [category, yogaItems] of Object.entries(yogas)) {
                    // Skip empty categories
                    if (!yogaItems || (Array.isArray(yogaItems) && yogaItems.length === 0)) {
                        continue;
                    }
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'yoga-category mb-4';
                    
                    // Create category header
                    const categoryHeader = document.createElement('h5');
                    categoryHeader.className = 'yoga-category-header mb-3';
                    categoryHeader.textContent = categoryNames[category] || category;
                    categoryDiv.appendChild(categoryHeader);
                    
                    // For categories with multiple yogas
                    if (Array.isArray(yogaItems)) {
                        if (yogaItems.length === 0) {
                            const noYogaDiv = document.createElement('p');
                            noYogaDiv.textContent = 'No yogas of this type found in the chart.';
                            categoryDiv.appendChild(noYogaDiv);
                        } else {
                            yogaItems.forEach(yoga => {
                                const yogaDiv = createYogaItemDiv(yoga);
                                categoryDiv.appendChild(yogaDiv);
                            });
                        }
                    } else {
                        // For single yoga items
                        const yogaDiv = createYogaItemDiv(yogaItems);
                        categoryDiv.appendChild(yogaDiv);
                    }
                    
                    yogasContainer.appendChild(categoryDiv);
                }
            }
            
            // Helper function to create a yoga item div
            function createYogaItemDiv(yoga) {
                const yogaDiv = document.createElement('div');
                yogaDiv.className = 'yoga-item card mb-3';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                // Yoga name/type
                const nameDiv = document.createElement('h6');
                nameDiv.className = 'card-title yoga-name';
                nameDiv.textContent = yoga.type || yoga.name || 'Unnamed Yoga';
                cardBody.appendChild(nameDiv);
                
                // Yoga description
                if (yoga.description) {
                    const descDiv = document.createElement('p');
                    descDiv.className = 'card-text yoga-description';
                    descDiv.textContent = yoga.description;
                    cardBody.appendChild(descDiv);
                }
                
                // Planets involved
                if (yoga.planets && Array.isArray(yoga.planets)) {
                    const planetsDiv = document.createElement('p');
                    planetsDiv.className = 'yoga-planets';
                    planetsDiv.innerHTML = `<strong>Planets:</strong> ${yoga.planets.join(', ')}`;
                    cardBody.appendChild(planetsDiv);
                }
                
                // Single planet (for Pancha Mahapurusha Yogas)
                if (yoga.planet && !Array.isArray(yoga.planet)) {
                    const planetDiv = document.createElement('p');
                    planetDiv.className = 'yoga-planet';
                    planetDiv.innerHTML = `<strong>Planet:</strong> ${yoga.planet}`;
                    cardBody.appendChild(planetDiv);
                }
                
                // House information if available
                if (yoga.house) {
                    const houseDiv = document.createElement('p');
                    houseDiv.className = 'yoga-house';
                    houseDiv.innerHTML = `<strong>House:</strong> ${yoga.house}`;
                    cardBody.appendChild(houseDiv);
                }
                
                // Position information (for Pancha Mahapurusha Yogas)
                if (yoga.position) {
                    const positionDiv = document.createElement('p');
                    positionDiv.className = 'yoga-position';
                    positionDiv.innerHTML = `<strong>Position:</strong> ${yoga.position}`;
                    cardBody.appendChild(positionDiv);
                }
                
                // Yoga strength if available
                if (yoga.strength !== undefined) {
                    const strengthDiv = document.createElement('div');
                    strengthDiv.className = 'yoga-strength mt-2';
                    
                    // Convert numerical strength to text
                    let strengthText;
                    let strengthClass;
                    
                    if (typeof yoga.strength === 'number') {
                        if (yoga.strength >= 0.8) {
                            strengthText = 'Strong';
                            strengthClass = 'text-success';
                        } else if (yoga.strength >= 0.5) {
                            strengthText = 'Moderate';
                            strengthClass = 'text-primary';
                        } else {
                            strengthText = 'Weak';
                            strengthClass = 'text-warning';
                        }
                    } else {
                        strengthText = yoga.strength;
                        
                        if (String(yoga.strength).toLowerCase().includes('strong')) {
                            strengthClass = 'text-success';
                        } else if (String(yoga.strength).toLowerCase().includes('moderate')) {
                            strengthClass = 'text-primary';
                        } else {
                            strengthClass = 'text-warning';
                        }
                    }
                    
                    strengthDiv.innerHTML = `<strong>Strength:</strong> <span class="${strengthClass}">${strengthText}</span>`;
                    cardBody.appendChild(strengthDiv);
                }
                
                yogaDiv.appendChild(cardBody);
                return yogaDiv;
            }
            
            // Function to open divisional chart tab
            function openDivisionalTab(evt, chartName) {
                // Hide all divisional content
                const divisionalContent = document.getElementsByClassName('divisional-content');
                for (let i = 0; i < divisionalContent.length; i++) {
                    divisionalContent[i].style.display = 'none';
                    divisionalContent[i].classList.remove('active');
                }
                
                // Remove "active" class from all tabs
                const divisionalTabs = document.getElementsByClassName('divisional-tab');
                for (let i = 0; i < divisionalTabs.length; i++) {
                    divisionalTabs[i].classList.remove('active');
                }
                
                // Show the current tab and add "active" class
                document.getElementById(chartName).style.display = 'block';
                document.getElementById(chartName).classList.add('active');
                evt.currentTarget.classList.add('active');
            }
            
            // Helper function to format date
            function formatDate(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString();
            }
            
            // Helper function to get planet symbols
            function getPlanetSymbol(planet) {
                const symbols = {
                    'Sun': '☉',
                    'Moon': '☽',
                    'Mercury': '☿',
                    'Venus': '♀',
                    'Mars': '♂',
                    'Jupiter': '♃',
                    'Saturn': '♄',
                    'Rahu': '☊',
                    'Ketu': '☋',
                    'Uranus': '♅',
                    'Neptune': '♆',
                    'Pluto': '♇'
                };
                
                return symbols[planet] || '';
            }
            
            // Helper function to convert longitude to zodiac sign and degrees
            function longitudeToZodiac(longitude) {
                const signs = [
                    'Aries', 'Taurus', 'Gemini', 'Cancer', 
                    'Leo', 'Virgo', 'Libra', 'Scorpio', 
                    'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'
                ];
                
                const signIndex = Math.floor(longitude / 30) % 12;
                const degrees = longitude % 30;
                
                return {
                    sign: signs[signIndex],
                    degrees: degrees
                };
            }
            
            // Helper function to get zodiac symbols
            function getZodiacSymbol(sign) {
                const symbols = {
                    'Aries': '♈',
                    'Taurus': '♉',
                    'Gemini': '♊',
                    'Cancer': '♋',
                    'Leo': '♌',
                    'Virgo': '♍',
                    'Libra': '♎',
                    'Scorpio': '♏',
                    'Sagittarius': '♐',
                    'Capricorn': '♑',
                    'Aquarius': '♒',
                    'Pisces': '♓'
                };
                
                return symbols[sign] || '';
            }
            
            // Helper function to format degrees, minutes, seconds
            function formatDMS(degrees) {
                const d = Math.floor(degrees);
                const mFloat = (degrees - d) * 60;
                const m = Math.floor(mFloat);
                const s = Math.round((mFloat - m) * 60);
                
                return `${d}° ${m}' ${s}"`;
            }
            
            // Helper function to format degree
            function formatDegree(degree) {
                return `${degree}°`;
            }
            
            // Function to display ascendant data
            function displayAscendantData(ascendant) {
                const ascendantTableBody = document.getElementById('ascendant-table-body');
                ascendantTableBody.innerHTML = '';
                
                if (ascendant) {
                    const row = document.createElement('tr');
                    
                    // Get zodiac symbol
                    const zodiacSymbol = getZodiacSymbol(ascendant.sign);
                    
                    // Format degrees
                    const formattedDegrees = ascendant.formatted_degree || formatDMS(ascendant.degree);
                    
                    row.innerHTML = `
                        <td><span class="zodiac-symbol">${zodiacSymbol}</span> ${ascendant.sign}</td>
                        <td>${formattedDegrees}</td>
                        <td>1</td>
                    `;
                    
                    ascendantTableBody.appendChild(row);
                } else {
                    ascendantTableBody.innerHTML = '<tr><td colspan="3">Ascendant data not available</td></tr>';
                }
            }
            
            // Function to display ascendant info
            function displayAscendantInfo(ascendant) {
                const ascSignSpan = document.getElementById('asc-sign');
                const ascDegreeSpan = document.getElementById('asc-degree');
                const ascNakshatraSpan = document.getElementById('asc-nakshatra');
                const ascPadaSpan = document.getElementById('asc-pada');
                
                // Check if elements exist before trying to set their content
                if (ascendant) {
                    if (ascSignSpan) ascSignSpan.textContent = ascendant.sign || '-';
                    if (ascDegreeSpan) ascDegreeSpan.textContent = ascendant.formatted_degree || formatDMS(ascendant.degree) || '-';
                    if (ascNakshatraSpan) ascNakshatraSpan.textContent = ascendant.nakshatra || '-';
                    if (ascPadaSpan) ascPadaSpan.textContent = ascendant.pada || '-';
                } else {
                    // Still check if elements exist
                    if (ascSignSpan) ascSignSpan.textContent = '-';
                    if (ascDegreeSpan) ascDegreeSpan.textContent = '-';
                    if (ascNakshatraSpan) ascNakshatraSpan.textContent = '-';
                    if (ascPadaSpan) ascPadaSpan.textContent = '-';
                }
            }
            
            // Function to display Ashtakavarga data
            function displayAshtakavarga(ashtakavargaData) {
                const container = document.getElementById('ashtakavarga-content');
                if (!container) {
                    console.error('Ashtakavarga content container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                // Check if ashtakavargaData exists
                if (!ashtakavargaData || !ashtakavargaData.sarvashtakavarga || !ashtakavargaData.prastarashtakavarga) {
                    container.innerHTML = '<div class="alert alert-info">No Ashtakavarga data available</div>';
                    return;
                }
                
                // Display Sarvashtakavarga
                const sarvashtakavargaDiv = document.createElement('div');
                sarvashtakavargaDiv.innerHTML = `
                    <h4>Sarvashtakavarga</h4>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>House</th>
                                <th>Total Bindus</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(ashtakavargaData.sarvashtakavarga).map(([house, bindus]) => `
                                <tr>
                                    <td>${parseInt(house) + 1}</td>
                                    <td>${bindus}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                container.appendChild(sarvashtakavargaDiv);
                
                // Display individual Ashtakavargas
                const planetsDiv = document.createElement('div');
                planetsDiv.innerHTML = `
                    <h4 class="mt-4">Prastarashtakavarga</h4>
                    <div class="accordion" id="ashtakavargaAccordion">
                        ${Object.entries(ashtakavargaData.prastarashtakavarga).map(([planet, houses], index) => `
                            <div class="card">
                                <div class="card-header" id="heading${index}">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                                            ${planet} Ashtakavarga
                                        </button>
                                    </h5>
                                </div>
                                <div id="collapse${index}" class="collapse" aria-labelledby="heading${index}" data-bs-parent="#ashtakavargaAccordion">
                                    <div class="card-body">
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>House</th>
                                                    <th>Bindu</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(houses).map(([house, bindu]) => `
                                                    <tr>
                                                        <td>${parseInt(house) + 1}</td>
                                                        <td>${bindu}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(planetsDiv);
            }
            
            // Function to display Shadbala data
            function displayShadbala(shadbalaData) {
                const container = document.getElementById('shadbala-content');
                if (!container) {
                    console.error('Shadbala content container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                // Check if shadbalaData exists
                if (!shadbalaData || Object.keys(shadbalaData).length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No Shadbala data available</div>';
                    return;
                }
                
                // Create summary table
                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = `
                    <h4>Shadbala Summary</h4>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Planet</th>
                                <th>Total Strength (Rupas)</th>
                                <th>Required Strength</th>
                                <th>Shadbala Pinda</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(shadbalaData).map(([planet, data]) => `
                                <tr>
                                    <td>${planet}</td>
                                    <td>${data.total_rupas.toFixed(2)}</td>
                                    <td>${data.required_strength.toFixed(2)}</td>
                                    <td>${data.shadbala_pinda.toFixed(2)}</td>
                                    <td>${data.is_strong ? '<span class="text-success">Strong</span>' : '<span class="text-danger">Weak</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                container.appendChild(summaryDiv);
                
                // Create detailed accordion for each planet
                const detailsDiv = document.createElement('div');
                detailsDiv.innerHTML = `
                    <h4 class="mt-4">Detailed Shadbala</h4>
                    <div class="accordion" id="shadbalaAccordion">
                        ${Object.entries(shadbalaData).map(([planet, data], index) => `
                            <div class="card">
                                <div class="card-header" id="shadbalaHeading${index}">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shadbalaCollapse${index}" aria-expanded="false" aria-controls="shadbalaCollapse${index}">
                                            ${planet} Shadbala Details
                                        </button>
                                    </h5>
                                </div>
                                <div id="shadbalaCollapse${index}" class="collapse" aria-labelledby="shadbalaHeading${index}" data-bs-parent="#shadbalaAccordion">
                                    <div class="card-body">
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Strength Type</th>
                                                    <th>Value (Virupas)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Sthana Bala (Positional)</td>
                                                    <td>${data.sthana_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Dig Bala (Directional)</td>
                                                    <td>${data.dig_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Kala Bala (Temporal)</td>
                                                    <td>${data.kala_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Chesta Bala (Motional)</td>
                                                    <td>${data.chesta_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Naisargika Bala (Natural)</td>
                                                    <td>${data.naisargika_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Drik Bala (Aspectual)</td>
                                                    <td>${data.drik_bala.total.toFixed(2)}</td>
                                                </tr>
                                                <tr class="table-primary">
                                                    <td><strong>Total (Virupas)</strong></td>
                                                    <td><strong>${data.total_virupas.toFixed(2)}</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <h5 class="mt-3">Kala Bala Components</h5>
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Component</th>
                                                    <th>Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Natonnata Bala</td>
                                                    <td>${data.kala_bala.natonnata_bala.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Paksha Bala</td>
                                                    <td>${data.kala_bala.paksha_bala.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Tribhaga Bala</td>
                                                    <td>${data.kala_bala.tribhaga_bala.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Other Temporal Strength</td>
                                                    <td>${data.kala_bala.other_temporal_strength.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Ayana Bala</td>
                                                    <td>${data.kala_bala.ayana_bala.toFixed(2)}</td>
                                                </tr>
                                                <tr>
                                                    <td>Yuddha Bala</td>
                                                    <td>${data.kala_bala.yuddha_bala.toFixed(2)}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(detailsDiv);
            }
            
            // Function to display Vimsopaka Bala data
            function displayVimsopakaBala(vimsopakaBalaData) {
                const container = document.getElementById('vimsopaka-content');
                if (!container) {
                    console.error('Vimsopaka Bala content container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                // Check if vimsopakaBalaData exists
                if (!vimsopakaBalaData || Object.keys(vimsopakaBalaData).length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No Vimsopaka Bala data available</div>';
                    return;
                }
                
                // Filter out non-planet keys like 'summary' and 'ranked_planets'
                const planetKeys = Object.keys(vimsopakaBalaData).filter(key => 
                    !['summary', 'ranked_planets', 'error'].includes(key));
                
                // Get ranked planets if available, otherwise use regular planet keys
                const rankedPlanets = vimsopakaBalaData.ranked_planets || planetKeys;
                
                // Create visual strength meter
                const strengthMeterDiv = document.createElement('div');
                strengthMeterDiv.className = 'mb-4';
                strengthMeterDiv.innerHTML = `
                    <h4>Vimsopaka Bala Strength Visualization</h4>
                    <div class="row">
                        <div class="col-md-8 offset-md-2">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small>Very Weak</small>
                                        <small>Weak</small>
                                        <small>Moderate</small>
                                        <small>Good</small>
                                        <small>Excellent</small>
                                    </div>
                                    <div class="progress" style="height: 30px; background-color: #f8f9fa;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">0-20%</div>
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">20-40%</div>
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">40-60%</div>
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">60-80%</div>
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">80-100%</div>
                                    </div>
                                    
                                    <div class="planet-strength-indicators mt-4">
                                        ${rankedPlanets.map(planet => {
                                            const data = vimsopakaBalaData[planet];
                                            if (!data || data.percentage === undefined) return '';
                                            
                                            // Determine color based on strength category
                                            let colorClass;
                                            if (data.percentage >= 80) colorClass = 'bg-success';
                                            else if (data.percentage >= 60) colorClass = 'bg-primary';
                                            else if (data.percentage >= 40) colorClass = 'bg-info';
                                            else if (data.percentage >= 20) colorClass = 'bg-warning';
                                            else colorClass = 'bg-danger';
                                            
                                            return `
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span>${getPlanetSymbol(planet)} ${planet}</span>
                                                    <span class="badge ${colorClass}">${data.strength_category}</span>
                                                </div>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar ${colorClass}" role="progressbar" 
                                                        style="width: ${data.percentage}%" 
                                                        aria-valuenow="${data.percentage}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                        ${data.normalized_score.toFixed(2)}/20 (${data.percentage.toFixed(2)}%)
                                                    </div>
                                                </div>
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(strengthMeterDiv);
                
                // Create summary table
                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = `
                    <h4>Vimsopaka Bala Summary</h4>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Planet</th>
                                <th>Normalized Score (out of 20)</th>
                                <th>Percentage Strength</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPlanets.map(planet => {
                                const data = vimsopakaBalaData[planet];
                                if (!data) return '';
                                
                                // Check if data and its properties exist
                                const normalizedScore = data.normalized_score !== undefined ? data.normalized_score.toFixed(2) : 'N/A';
                                const percentage = data.percentage !== undefined ? data.percentage.toFixed(2) : 'N/A';
                                
                                // Determine color class based on strength category
                                let colorClass;
                                if (data.percentage >= 80) colorClass = 'table-success';
                                else if (data.percentage >= 60) colorClass = 'table-primary';
                                else if (data.percentage >= 40) colorClass = 'table-info';
                                else if (data.percentage >= 20) colorClass = 'table-warning';
                                else colorClass = 'table-danger';
                                
                                return `
                                <tr class="${colorClass}">
                                    <td>${getPlanetSymbol(planet)} ${planet}</td>
                                    <td>${normalizedScore}</td>
                                    <td>${percentage}%</td>
                                    <td>${data.strength_category}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                container.appendChild(summaryDiv);
                
                // Create detailed accordion for each planet
                const detailsDiv = document.createElement('div');
                detailsDiv.innerHTML = `
                    <h4 class="mt-4">Detailed Vimsopaka Bala Analysis</h4>
                    <div class="accordion" id="vimsopakaAccordion">
                        ${rankedPlanets.map((planet, index) => {
                            const data = vimsopakaBalaData[planet];
                            if (!data) return '';
                            
                            // Determine color class based on strength category
                            let colorClass;
                            if (data.percentage >= 80) colorClass = 'success';
                            else if (data.percentage >= 60) colorClass = 'primary';
                            else if (data.percentage >= 40) colorClass = 'info';
                            else if (data.percentage >= 20) colorClass = 'warning';
                            else colorClass = 'danger';
                            
                            return `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="vimsopakaHeading${index}">
                                    <button class="accordion-button collapsed text-${colorClass}" type="button" data-bs-toggle="collapse" data-bs-target="#vimsopakaCollapse${index}" aria-expanded="false" aria-controls="vimsopakaCollapse${index}">
                                        ${getPlanetSymbol(planet)} ${planet} - ${data.strength_category} (${data.normalized_score.toFixed(2)}/20)
                                    </button>
                                </h2>
                                <div id="vimsopakaCollapse${index}" class="accordion-collapse collapse" aria-labelledby="vimsopakaHeading${index}" data-bs-parent="#vimsopakaAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5>Divisional Chart Contributions</h5>
                                                <table class="table table-bordered table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Chart</th>
                                                            <th>Dignity</th>
                                                            <th>Weight</th>
                                                            <th>Points</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${Object.entries(data.chart_points || {}).map(([chart, chartData]) => {
                                                            if (!chartData) return '';
                                                            
                                                            // Check if chartData and its properties exist
                                                            const dignityFactor = chartData.dignity_factor !== undefined ? chartData.dignity_factor.toFixed(2) : 'N/A';
                                                            const weight = chartData.weight !== undefined ? chartData.weight.toFixed(2) : 'N/A';
                                                            const points = chartData.points !== undefined ? chartData.points.toFixed(2) : 'N/A';
                                                            
                                                            // Determine color based on dignity factor
                                                            let rowClass = '';
                                                            if (chartData.dignity_factor >= 0.75) rowClass = 'table-success';
                                                            else if (chartData.dignity_factor >= 0.5) rowClass = 'table-primary';
                                                            else if (chartData.dignity_factor >= 0.25) rowClass = 'table-warning';
                                                            else rowClass = 'table-danger';
                                                            
                                                            return `
                                                            <tr class="${rowClass}">
                                                                <td>${chart}</td>
                                                                <td>${dignityFactor}</td>
                                                                <td>${weight}</td>
                                                                <td>${points}</td>
                                                            </tr>
                                                            `;
                                                        }).join('')}
                                                        <tr class="table-primary">
                                                            <td colspan="3"><strong>Total Points</strong></td>
                                                            <td><strong>${data.total_points ? data.total_points.toFixed(2) : 'N/A'}</strong></td>
                                                        </tr>
                                                        <tr class="table-info">
                                                            <td colspan="3"><strong>Normalized Score (out of 20)</strong></td>
                                                            <td><strong>${data.normalized_score ? data.normalized_score.toFixed(2) : 'N/A'}</strong></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card border-${colorClass} h-100">
                                                    <div class="card-header bg-${colorClass} text-white">
                                                        <h5 class="mb-0">Interpretation</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p>${data.interpretation || `${planet} has a Vimsopaka Bala strength of ${data.percentage ? data.percentage.toFixed(2) : 'N/A'}%, making it ${data.strength_category}.`}</p>
                                                        
                                                        <div class="mt-3">
                                                            <h6>Strength Distribution</h6>
                                                            <canvas id="vimsopakaPieChart${index}" width="100%" height="200"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(detailsDiv);
                
                // Create pie charts for each planet after the DOM is updated
                setTimeout(() => {
                    rankedPlanets.forEach((planet, index) => {
                        const data = vimsopakaBalaData[planet];
                        if (!data || !data.chart_points) return;
                        
                        const chartElement = document.getElementById(`vimsopakaPieChart${index}`);
                        if (!chartElement) return;
                        
                        const chartLabels = [];
                        const chartData = [];
                        const chartColors = [
                            '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
                            '#3F51B5', '#009688', '#795548', '#607D8B', '#E91E63',
                            '#CDDC39', '#00BCD4', '#8BC34A', '#673AB7', '#F44336'
                        ];
                        
                        Object.entries(data.chart_points).forEach(([chart, chartInfo]) => {
                            if (chartInfo && chartInfo.points !== undefined) {
                                chartLabels.push(chart);
                                chartData.push(chartInfo.points);
                            }
                        });
                        
                        // Create pie chart using Chart.js
                        if (typeof Chart !== 'undefined') {
                            new Chart(chartElement, {
                                type: 'pie',
                                data: {
                                    labels: chartLabels,
                                    datasets: [{
                                        data: chartData,
                                        backgroundColor: chartColors.slice(0, chartLabels.length),
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: {
                                            position: 'right',
                                            labels: {
                                                boxWidth: 12
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const label = context.label || '';
                                                    const value = context.raw || 0;
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = Math.round((value / total) * 100);
                                                    return `${label}: ${value.toFixed(2)} (${percentage}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                }, 500);
            }
            
            // Function to display Ishta-Kashta Phala data
            function displayIshtaKashtaPhala(ishtaKashtaPhalaData) {
                const container = document.getElementById('ishta-kashta-content');
                if (!container) {
                    console.error('Ishta-Kashta Phala content container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                // Check if ishtaKashtaPhalaData exists
                if (!ishtaKashtaPhalaData || Object.keys(ishtaKashtaPhalaData).length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No Ishta-Kashta Phala data available</div>';
                    return;
                }
                
                // Create summary table
                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = `
                    <h4>Ishta-Kashta Phala Summary</h4>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Planet</th>
                                <th>Total Points (out of 20)</th>
                                <th>Percentage Strength</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(ishtaKashtaPhalaData).map(([planet, data]) => {
                                // Check if data and its properties exist
                                const totalPoints = data && data.total_points !== undefined ? data.total_points.toFixed(2) : 'N/A';
                                const percentage = data && data.percentage !== undefined ? data.percentage.toFixed(2) : 'N/A';
                                const isStrong = data && data.is_strong !== undefined ? data.is_strong : false;
                                
                                return `
                                <tr>
                                    <td>${planet}</td>
                                    <td>${totalPoints}</td>
                                    <td>${percentage}%</td>
                                    <td>${isStrong ? '<span class="text-success">Strong</span>' : '<span class="text-danger">Weak</span>'}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                container.appendChild(summaryDiv);
                
                // Create detailed accordion for each planet
                const detailsDiv = document.createElement('div');
                detailsDiv.innerHTML = `
                    <h4 class="mt-4">Detailed Ishta-Kashta Phala</h4>
                    <div class="accordion" id="ishta-kashta-accordion">
                        ${Object.entries(ishtaKashtaPhalaData).map(([planet, data], index) => `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="ishta-kashta-heading${index}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ishta-kashta-collapse${index}" aria-expanded="false" aria-controls="ishta-kashta-collapse${index}">
                                        ${planet} Ishta-Kashta Phala Details
                                    </button>
                                </h2>
                                <div id="ishta-kashta-collapse${index}" class="accordion-collapse collapse" aria-labelledby="ishta-kashta-heading${index}" data-bs-parent="#ishta-kashta-accordion">
                                    <div class="accordion-body">
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Divisional Chart</th>
                                                    <th>Dignity Factor</th>
                                                    <th>Weight</th>
                                                    <th>Points</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(data.chart_points).map(([chart, chartData]) => {
                                                    // Check if chartData and its properties exist
                                                    const dignityFactor = chartData && chartData.dignity_factor !== undefined ? chartData.dignity_factor.toFixed(2) : 'N/A';
                                                    const weight = chartData && chartData.weight !== undefined ? chartData.weight.toFixed(2) : 'N/A';
                                                    const points = chartData && chartData.points !== undefined ? chartData.points.toFixed(2) : 'N/A';
                                                    
                                                    return `
                                                    <tr>
                                                        <td>${chart}</td>
                                                        <td>${dignityFactor}</td>
                                                        <td>${weight}</td>
                                                        <td>${points}</td>
                                                    </tr>
                                                    `;
                                                }).join('')}
                                                <tr class="table-primary">
                                                    <td colspan="3"><strong>Total Points (out of 20)</strong></td>
                                                    <td><strong>${data.total_points.toFixed(2)}</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <div class="mt-3">
                                            <h5>Interpretation</h5>
                                            <p>
                                                ${planet} has an Ishta-Kashta Phala strength of ${data.percentage.toFixed(2)}%, making it 
                                                ${data.is_strong 
                                                    ? `strong. This indicates that ${planet} will generally produce favorable results related to the houses it rules and aspects.` 
                                                    : `weak. This indicates that ${planet} may struggle to produce favorable results related to the houses it rules and aspects.`}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(detailsDiv);
            }
        });
    </script>
</body>
</html>
